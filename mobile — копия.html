<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sanskrit_Keybard</title>
  <link rel="icon" href="icons/IconWebMain.ico" type="image/x-icon">
  <style>

@font-face {
  font-family: 'Andika';
  src: url('./fonts/Andika-Regular.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: 'SanskritFont';
  src: url('./fonts/L_Shobhika-Regular.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}


body {
  font-family: "Andika", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

    :root {
      --kbd-width: 360px;
      --gap: 8px;
      --key-height: 46px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Andika';
      background: #f5f7fa;
      color: #111;
    }
    

    .deva {
  font-family: 'SanskritFont', 'Andika', sans-serif !important;
}


.app {
  display: flex;
  height: 100svh; 
  gap: 12px;
  padding: 12px;
  box-sizing: border-box;
}

    .editor { flex: 1; display: flex; flex-direction: column; }

textarea#mainText {
  flex: 1;
  resize: none;
  padding: 14px;
  font-size: 18px;
  line-height: 1.5;
  letter-spacing: 0.1px;
  border-radius: 12px;
  border: 1px solid #A2A2A2;
  box-sizing: border-box;
  background: #fff;
  -webkit-user-select: text;
  user-select: text;
  overflow: auto;
  min-height: 967px;

  font-family: 'Andika', 'SanskritFont', system-ui, sans-serif;
}


    .keyboard {
      width: var(--kbd-width);
      min-width: 170px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #ffffff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 6px 18px rgba(20,30,50,0.06);
      position: relative; 
    }

    .controls { display: flex; flex-direction: column; gap: 8px; }
    .row-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 6px 8px; border-radius: 10px; border: 1px solid #999; background: #f0f0f0; cursor: pointer; font-size: 14px; }
    .btn.secondary { background: #fff; }
    .btn.toggle-active { background: #e8fff0; border-color: #58b16a; }
    .status { font-size: 13px; color: inherit; }
    .small { font-size: 12px; opacity: .85; }

    .rows {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
      max-height: 84vh;
      padding-right: 6px;
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
    }

    .row { display: grid; gap: var(--gap); }
    .key {
      height: var(--key-height);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: 1px solid #d0d6df;
      background: #fbfdff;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding: 8px 10px;
      font-size: 20px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
      transition: transform .08s ease, background .12s ease;
      touch-action: manipulation;
      color: #111;
    }
    .key:active { transform: translateY(1px) scale(.96); }
    .key:hover { background: #eef5ff; }
    .key.empty {
      background: transparent; border: none; cursor: default; box-shadow: none; height: var(--key-height);
    }

    .btn {
      transition: transform 0.15s ease;
    }

    .btn:active {
      transform: scale(0.94);
    }

    .key:focus,
    .btn:focus {
      outline: none;
      box-shadow: none;
    }
    .key, .btn {
      -webkit-tap-highlight-color: transparent;
      outline: none;
      box-shadow: none;
    }

    .theme-toggle {
      width: 90px;
      height: 38px;
      border-radius: 19px;
      background: #ddd;
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 4px;
      box-sizing: border-box;
      transition: background 0.3s ease;
    }

    .theme-toggle .thumb {
      width: 30px;
      height: 30px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 4px;
      top: 4px;
      transition: left 0.3s ease;
      user-select: none;
      touch-action: none;
      font-size: 16px;
    }

    .theme-toggle.night {
      background: #333;
    }
    .theme-toggle.night .thumb {
      left: 56px;
    }

    .legend { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }


.jumpBtn,
.smallBtn {
  display: flex !important;
  align-items: center !important;     
  justify-content: center !important; 
  box-sizing: border-box !important;
  padding: 0 !important;
  margin: 0 !important;
  line-height: 1 !important;
  text-align: center !important;
  min-width: 44px !important;   
  height: 44px !important;      
  gap: 0 !important;
  overflow: hidden !important;
  vertical-align: middle !important;
  font-size: 16px !important;  
}

.jumpBtn > * ,
.smallBtn > * {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  margin: 0 !important;
  padding: 0 !important;
  height: 100% !important;
  width: auto !important;
  line-height: 1 !important;
}

.jumpBtn img,
.smallBtn img {
  display: none !important;
}

.jumpBtn,
.smallBtn {
  transform: translateY(1) !important;
}

.smallBtn.deva {
  font-family: 'SanskritFont', 'Andika', sans-serif !important;
}


    @media (max-width: 900px) {
      .app { flex-direction: column; padding: 10px; gap: 10px; }
      .keyboard {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        width: auto;
        border-radius: 14px 14px 0 0;
        z-index: 9999;
        box-shadow: 0 -2px 18px rgba(20,30,50,0.18);
        max-height: 48vh;
      }


      .rows {
        max-height: 23vh;
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
      }

      textarea#mainText { font-size: 19px; min-height: 40vh; }
      .editor { order: 1; }
    }

body.dark {
  background: #000 !important;
  color: #fff !important;
}

body.dark .app,
body.dark textarea#mainText,
body.dark .keyboard,
body.dark .rows,
body.dark .key,
body.dark .btn,
body.dark .small,
body.dark .status {
  color: inherit;
  background: none;
}

body.dark textarea#mainText {
  background: #000 !important;
  color: #fff !important;
  border-color: #222 !important;
}
body.dark .keyboard {
  background: #000 !important;
  border-color: #222 !important;
  box-shadow: none !important;
}
body.dark .key { background: #111 !important; color: #fff !important; border-color: #333 !important; }
body.dark .btn { background: #111 !important; color: #fff !important; border-color: #444 !important; }


    .icon-btn {
      width: clamp(40px, 9vw, var(--key-height));
      height: clamp(40px, 9vw, var(--key-height));
      min-width: 44px;
      min-height: 44px;
      padding: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      margin-left: 6px;
      border-radius: 10px;
    }

    .icon-btn img.icon-img {
      width: 70%;
      height: 70%;
      max-width: 22px;
      max-height: 22px;
      object-fit: contain;
      pointer-events: none;
      transition: filter .15s ease, opacity .15s ease, transform .12s ease;
      display: inline-block;
    }

    .icon-btn svg.icon-fallback { display:none; width:70%; height:70%; max-width:22px; max-height:22px; }

    body.dark .icon-btn img.icon-img { filter: invert(1) grayscale(0); }

    #capsBtn.caps-dim { background: #e9e9e9; border-color: #cfcfcf; }
    #capsBtn.caps-green { background: #58b16a; border-color: #3c9a4a; color: #fff; }
    body.dark #capsBtn.caps-green { background: #2b7a3a; border-color: #1f5b2a; color: #fff; }

    #capsBtn.caps-dim img.icon-img { opacity: 0.65; transform: scale(0.98); }
    #capsBtn.caps-green img.icon-img { opacity: 1; transform: scale(1); }

    @media (max-width: 420px) {
      .icon-btn { padding: 4px; }
      .icon-btn img.icon-img, .icon-btn svg.icon-fallback { max-width: 18px; max-height: 18px; }
    }



#settingsBtn .icon-img {
  width: 37px !important;
  height: 45px !important;
  max-width: none !important;
  max-height: none !important;
  display: block;
  object-fit: contain;
    object-fit: contain;
  transform: translateY(1.5px);
   transform: translateX(-1.px);
}

#copyBtn .icon-img {
  width: 21px !important;
  height: 28px !important;
  max-width: none !important;
  max-height: none !important;
  display: block;
  object-fit: contain;
}
#backspaceBtn .icon-img {
  width: 30px !important;
  height: 26px !important;
  max-width: none !important;
  max-height: none !important;
  display: block;
  object-fit: contain;
  transform: translateX(-0.3px);
}
#spaceBtn {
  min-width: 50px !important;
  width: 80px !important;
}
#spaceBtn .icon-img {
  width: 28px !important;
  height: 26px !important;
  max-width: none !important;
  max-height: none !important;
  display: block;
  object-fit: contain;
  transform: translateY(3px);
}
#capsBtn .icon-img {
  transform: translateX(0.6px);
}
    .theme-toggle {
  outline: none;          
  box-shadow: none;       
  -webkit-tap-highlight-color: transparent; 
}

.theme-toggle:focus,
.theme-toggle:active {
  outline: none;
  box-shadow: none;
  background-color: inherit; 
}


#settingsPopup {
  position: absolute;
  top: 52px;
  left: 10px;
  background: #fff;
  color: #111;
  border: 1px solid #ddd;
  padding: 8px;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(10,20,40,0.12);
  z-index: 999;
  min-width: 180px;
  max-width: 320px;
}
#settingsPopup.hidden { display: none; }
#settingsPopup h4 { margin: 6px 0 6px 0; font-size: 13px; }
#settingsPopup select {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px 8px;
  box-sizing: border-box;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 13px;
}
#settingsPopup .note { font-size: 12px; opacity: .8; margin-top:4px; }


    @media (max-width: 420px) {
      #settingsPopup {
    left: 12px;
    right: 12px;
    top: 54px;
    min-width: unset;
    width: calc(100% - 24px);
    padding: 8px;
    border-radius: 12px;
    }
  }
body.dark #settingsPopup { background: #0b0b0b; color: #fff; border-color: #222; }
  
.keyboard, .key, .key span, .jumpBtn {
  font-family: inherit;
}

.jumpBtn[data-row="1"] {
  display: inline-flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 2px;
}

.jumpBtn[data-row="1"] > * {
  display: inline-block;
  transform: translateY(.33h);
  line-height: 1;
}


#spaceBtn {
  flex-shrink: 0 !important;   
}


.rows::-webkit-scrollbar,
textarea::-webkit-scrollbar {
  width: 10px;
}

.rows::-webkit-scrollbar-track,
textarea::-webkit-scrollbar-track {
  background: transparent;      
  border-radius: 10px;
  box-shadow: inset 0 0 0 10px #ffffff; 
}

.rows::-webkit-scrollbar-thumb,
textarea::-webkit-scrollbar-thumb {
  background: #c2c2c2;
  border-radius: 10px;
  border: 2px solid #ffffff;    
}

.rows::-webkit-scrollbar-thumb:hover,
textarea::-webkit-scrollbar-thumb:hover {
  background: #b0b0b0;
}

.rows,
textarea {
  scrollbar-width: thin;
  scrollbar-color: #b8b8b8 #ffffff;
}

body.dark .rows::-webkit-scrollbar-track,
body.dark textarea::-webkit-scrollbar-track {
  box-shadow: inset 0 0 0 10px #000;   
}

body.dark .rows::-webkit-scrollbar-thumb,
body.dark textarea::-webkit-scrollbar-thumb {
  background: #666;
  border: 2px solid #000;
}

body.dark .rows::-webkit-scrollbar-thumb:hover,
body.dark textarea::-webkit-scrollbar-thumb:hover {
  background: #777;
}

body.dark .rows,
body.dark textarea {
  scrollbar-color: #777 #000;
}



#textWrapper {
  position: relative;
  display: inline-block;
}

#saveBtn,#snowToggleBtn {

  top: 8px;
  right: 8px;

  width: 38px;
  height: 38px;

  background: #4a90e2;
  color: white;
  font-size: 20px;

  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  z-index: 9999;
  user-select: none;
}

#saveModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
}

#saveWrapper {
  width: 320px;
  max-height: 70vh;
  background: white;
  border-radius: 20px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  overflow: hidden;
}

#saveList {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.saveItem {
  padding: 12px;
  background: #eef4ff;
  border-radius: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.deleteSave {
  color: red;
  font-size: 20px;
  cursor: pointer;
}

.openSave {
  font-size: 20px;
  cursor: pointer;
  background: none;
  border: none;
  margin-right: 5px;
}

#newSave {
  display: flex;
  gap: 10px;
}

#newSave input {
  flex: 1;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

#newSave button {
  padding: 8px 14px;
  border-radius: 10px;
  background: #4a90e2;
  color: white;
  border: none;
}

#closeSave {
  background: #888;
  border: none;
  padding: 12px;
  border-radius: 12px;
  color: white;
}


#textWrapper { position: relative; display: inline-block; width: 100%; }
#textWrapper textarea { box-sizing: border-box; width: 100%; }

#saveBtn,#snowToggleBtn{

  top: 10px;
  right: 10px;
  width: 42px;
  height: 42px;
  background: #4a90e2;
  color: #fff;
  font-size: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 99999;
  user-select: none;
  box-shadow: 0 6px 18px rgba(10,30,80,0.12);
}

#saveModal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.55); z-index: 100000; }
#saveWrapper { width: 320px; max-height: 75vh; background: var(--modal-bg,#fff); border-radius: 16px; padding: 18px; box-sizing: border-box; display:flex; flex-direction:column; gap:12px; overflow: hidden; }
#saveList { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:8px; padding-right:6px; }
.saveItem { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; background: #f1f7ff; }
.saveMeta { font-size:12px; color:#666; margin-top:6px; }
.openSave{ background:none; border:none; font-size:18px; cursor:pointer; margin-right:8px; }
.deleteSave{ background:none; border:none; font-size:18px; cursor:pointer; color:#d44; }

#newSave { display:flex; gap:8px; }
#newSave input { flex:1; padding:8px; border-radius:10px; border:1px solid #ccc; }
#newSave button { padding:8px 12px; border-radius:10px; border:none; background:#4a90e2; color:#fff; cursor:pointer; }

#closeSave{ margin-top:6px; padding:10px; border-radius:10px; border:none; background:#888; color:white; cursor:pointer; }

#saveList { -webkit-overflow-scrolling: touch; touch-action: pan-y; }


#saveModal {
  font-family: 'Andika', sans-serif !important;
}

#saveWrapper {
  background: #242424 !important;
  color: #ffffff !important;
  border: 1px solid #333 !important;
  font-family: 'Andika', sans-serif !important;
}

#saveWrapper h3 {
  color: #ffffff !important;
  font-family: 'Andika', sans-serif !important;
}

#saveList {
  background: #1e1e1e !important;
  border-radius: 12px;
  padding: 6px;
}

.saveItem {
  background: #2c2c2c !important;
  border: 1px solid #3b3b3b !important;
  color: #ffffff !important;
  font-family: 'Andika', sans-serif !important;
}

.saveItem strong {
  color: #ffffff !important;
}

.saveMeta {
  color: #bbbbbb !important;
}

.openSave, .deleteSave {
  background: none !important;
  border: none !important;
  cursor: pointer;
  font-size: 18px;
  color: #ffffff !important;
}

.deleteSave {
  color: #ff5c5c !important;
}

#newSave input {
  background: #1a1a1a;
  border: 1px solid #444 !important;
  color: #fff !important;
  border-radius: 10px;
  padding: 8px;
  font-family: 'Andika', sans-serif !important;
}

#newSave button {
  background:  #3a78ff !important;
  color: white !important;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  cursor: pointer;
  font-family: 'Andika', sans-serif !important;
}

#closeSave {
  background: #3a3a3a !important;
  color: white !important;
  border: none;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  font-family: 'Andika', sans-serif !important;
}

#saveList::-webkit-scrollbar {
  width: 8px;
}
#saveList::-webkit-scrollbar-track {
  background: #1a1a1a;
}
#saveList::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 4px;
}
#saveList::-webkit-scrollbar-thumb:hover {
  background: #555;
}

#textWrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#textWrapper textarea {
  flex: 1;
}




.saveItem button {
  width: 38px;
  height: 38px;
  border-radius: 10px;
  border: none;
  background: transparent;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 20px;            
  line-height: 1;
  user-select: none;

  transition:
    background 0.2s ease,
    transform 0.15s ease,
    box-shadow 0.2s ease;
}



.deleteSave:hover {
  background: linear-gradient(
    135deg,
    rgba(255, 60, 60, 0.35),
    rgba(180, 0, 0, 0.45)
  );
  box-shadow: 0 4px 14px rgba(255, 80, 80, 0.35);
}

.deleteSave:active {
  transform: scale(0.9);
}



.openSave:hover {
  background: rgba(80, 140, 255, 0.25);
  box-shadow: 0 4px 14px rgba(80, 140, 255, 0.25);
}

.openSave:active {
  transform: scale(0.9);
}

.saveItem button span {
  display: flex;
  width: 100%;
  height: 100%;

  align-items: center;
  justify-content: center;

  font-size: 20px;
  line-height: 1;

  transform-origin: center center;
  transition: transform 0.15s ease;
}


.saveActions {
  display: flex;
  flex-direction: row;   
  align-items: center;
  gap: 6px;
}


:root {
  --save-btn-bg: #4a90e2;
}

body.dark {
  --save-btn-bg: #242424;
}

#saveBtn {
  background: var(--save-btn-bg);
  color: #ffffff;
  transition: background 0.25s ease, transform 0.15s ease;
}


#langBtn img,
#langIconImg {
  transform: translateY(4px);
}



.lang-sheet {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 9999;
}

.lang-sheet-box {
  position: absolute;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  width: 92%;
  max-width: 420px;
  background: #2b2b2f;
  border-radius: 18px;
  overflow: hidden;
}

.lang-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 20px;
  color: #fff;
  font-size: 16px;
  border-bottom: 1px solid rgba(255,255,255,.08);
}

.lang-item:last-child {
  border-bottom: none;
}

.lang-item:active {
  background: rgba(255,255,255,.1);
}

.radio {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #aaa;
}

.lang-item.active .radio {
  background: #4da3ff;
  border-color: #4da3ff;
}

.hidden {
  display: none;
}


.lang-item {
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  cursor: pointer;
}

.lang-sheet, .lang-sheet-box, .lang-item {
  pointer-events: auto;
}



#textWrapper { position: relative; }

.textBtns {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 10001;
  pointer-events: auto;
}

#saveBtn {
  position: static; 
  margin: 0;
  width: 42px;
  height: 42px;
  border-radius: 50%;
}

#snowToggleBtn {

  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background-color: #1e1e1e;
}



#snowToggleBtn {
  position: absolute;          
  top: 10px;                   
  right: 60px;                 
}

#snowToggleBtn {
  position: absolute !important;
  top: 10px !important;
  right: 60px !important; 
}

#saveBtn {
  position: absolute !important;
  top: 10px !important;
  right: 10px !important;
}



#saveBtn,
#snowToggleBtn {
  width: 25px !important;    
  height: 25px !important;
  padding: 0;       
  font-size: 15px;

  display: flex;
  align-items: center;
  justify-content: center;
}
.textBtns {
  top: -5px !important; 
    right: -10px;
}

#saveBtn {
  top: -3px !important;
    right: -10px;
}

#snowToggleBtn {
  top: -3px !important;
    right: -10px;
}


.textBtns {
  position: absolute;
  top: -8px;
  right: -8px;
  overflow: visible;
}

.textBtns::before {
  content: "";
  position: absolute;
  z-index: -1;
  top: -20px;
  right: -1px;

  width: 84px;
  height: 45px;

  border-radius: 16px;
  transition: background 0.2s, border 0.2s, box-shadow 0.2s;
}

body:not(.dark) .textBtns::before {
  background: #ffffff;
  border: 1px solid #e6e6e6;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
}

body.dark .textBtns::before {
  background: rgba(0, 0, 0, 0.85);
  border: 1px solid #222222;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
}

#saveBtn,
#snowToggleBtn {
  position: relative;
  z-index: 1;
}



#snowToggleBtn {
  position: relative;
  left: -73px;  
}



body.dark #saveBtn,
body.dark #snowToggleBtn {
  border-radius: 50%;

  background: #111111;          
  border: 1px solid #2b2b2b;    
  color: #ffffff;

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.05),
    0 2px 4px rgba(0,0,0,0.6);
}


#saveBtn,
#snowToggleBtn {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
}

.btnIcon {
  width: 14px;
  height: 14px;
  fill: currentColor;
  pointer-events: none;
}

body:not(.dark) #snowToggleBtn {
  background-color: #4a90e2; 
}

body:not(.dark) #saveBtn {
  background-color: #55ad66; 
}


body.dark #capsBtn.caps-dim {
  border-color: #444 !important;
}

body.dark #capsBtn.caps-green {
  background: #2b7a3a !important;
  border-color: #1f5b2a !important;
}








/* ===== copied-from-desktop (NO MENTIONS OF #saveBtn) ===== */
:root{
  --glow-green-core: rgba(80,220,140,0.9);
  --glow-green-soft: rgba(80,220,140,0.32);
  --glow-green-ring: 1.4px;
  --glow-green-blur: 12px;
  --ctrl-radius: 10px;
}

/* Controls that will receive aura ‚Äî intentionally do NOT reference #saveBtn anywhere */
.controls .btn,
.controls .icon-btn,
#capsBtn,
#copyBtn,
#backspaceBtn,
#spaceBtn {
  position: relative;
  z-index: 1;
  overflow: visible;
  border-radius: var(--ctrl-radius);
}

/* shared ::after aura (inactive by default) */
.controls .btn::after,
.controls .icon-btn::after,
#capsBtn::after,
#copyBtn::after,
#backspaceBtn::after,
#spaceBtn::after{
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  pointer-events: none;
  opacity: 0;
  transition: opacity .16s ease, box-shadow .16s ease, transform .16s ease;
}

/* LIGHT THEME: visuals for controls (DO NOT AFFECT save button ‚Äî we never reference it) */
body:not(.dark) .controls .btn,
body:not(.dark) .controls .icon-btn,
body:not(.dark) #capsBtn,
body:not(.dark) #copyBtn,
body:not(.dark) #backspaceBtn,
body:not(.dark) #spaceBtn {
  background: #ffffff;
  color: #111;
  border: 1px solid #dfdfdf;
  box-shadow:
    0 8px 20px rgba(0,0,0,0.12),
    0 1px 0 rgba(255,255,255,0.7) inset;
  border-radius: var(--ctrl-radius);
  transition: transform .14s ease, box-shadow .14s ease, background .12s ease;
  -webkit-tap-highlight-color: transparent;
}

/* active/toggle state shows green aura (light) */
body:not(.dark) .controls .btn.toggle-active::after,
body:not(.dark) .controls .icon-btn.toggle-active::after,
body:not(.dark) #capsBtn.toggle-active::after,
body:not(.dark) #copyBtn.toggle-active::after,
body:not(.dark) #backspaceBtn.toggle-active::after,
body:not(.dark) #spaceBtn.toggle-active::after {
  opacity: 1;
  box-shadow:
    0 0 0 var(--glow-green-ring) var(--glow-green-core),
    0 0 var(--glow-green-blur) var(--glow-green-soft);
}

body:not(.dark) #capsBtn.caps-dim::after {
  opacity: 1;
  box-shadow: 0 0 0 1px var(--glow-green-core), 0 0 6px var(--glow-green-soft);
}
body:not(.dark) #capsBtn.caps-green::after {
  opacity: 1;
  box-shadow: 0 0 0 1.6px var(--glow-green-core), 0 0 12px var(--glow-green-soft);
}

body.dark .controls .btn,
body.dark .controls .icon-btn,
body.dark #capsBtn,
body.dark #copyBtn,
body.dark #backspaceBtn,
body.dark #spaceBtn {
  background: #121212;
  color: #f1f1f1;
  border: 1px solid #1f1f1f;
  box-shadow:
    0 8px 20px rgba(0,0,0,0.75),
    0 1px 0 rgba(255,255,255,0.06) inset;
  border-radius: var(--ctrl-radius);
  transition: transform .14s ease, box-shadow .14s ease, background .12s ease;
}

/* active/toggle state shows multi-layer green aura (dark) */
body.dark .controls .btn.toggle-active::after,
body.dark .controls .icon-btn.toggle-active::after,
body.dark #capsBtn.toggle-active::after,
body.dark #copyBtn.toggle-active::after,
body.dark #backspaceBtn.toggle-active::after,
body.dark #spaceBtn.toggle-active::after {
  opacity: 1;
  transform: scale(1.02);
  box-shadow:
    0 0 0 1.0px rgba(80,220,140,0.85),
    0 0 12px rgba(80,220,140,0.45),
    0 0 36px rgba(80,220,140,0.22);
}

body.dark #capsBtn.caps-dim::after{
  opacity:1;
  transform:scale(1.02);
  box-shadow: 0 0 0 1.2px rgba(120,255,180,0.72), 0 0 10px rgba(120,255,180,0.30);
}
body.dark #capsBtn.caps-green::after{
  opacity:1;
  transform:scale(1.02);
  box-shadow: 0 0 0 1.6px rgba(80,220,140,0.85), 0 0 12px rgba(80,220,140,0.45), 0 0 36px rgba(80,220,140,0.22);
}

#backspaceBtn,
#spaceBtn,
#copyBtn,
#capsBtn {
  width: 56px;
  height: 46px;
  min-width: 46px;
  min-height: 46px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px;
  box-sizing: border-box;
}

button[data-key="Enter"],
button[data-key="enter"],
.key.enter,
.key[data-key="Enter"],
.key[data-key="enter"] {
  min-width: 64px;
  padding-left: 12px;
  padding-right: 12px;
  border-radius: var(--ctrl-radius);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}




.controls .btn svg,
.controls .icon-btn svg,
#capsBtn svg,
#spaceBtn svg,
#backspaceBtn svg,
#copyBtn svg {
  width: 20px;
  height: 20px;
  display: block;
  fill: currentColor;
  stroke: none;
  vector-effect: non-scaling-stroke;
  pointer-events: none;
}

.controls .btn .icon-img,
.controls .icon-btn .icon-img,
#copyBtn .icon-img,
#backspaceBtn .icon-img {
  width: 20px !important;
  height: 20px !important;
  display: block;
  object-fit: contain;
  pointer-events: none;
}


body.dark .controls .btn:not(.snow-toggle),
body.dark .controls .icon-btn:not(.snow-toggle),
body.dark {
  background: #121212;
  color: #f1f1f1;
  border: 1px solid #1f1f1f !important;
  border-radius: 10px;
  box-shadow:
    0 8px 20px rgba(0, 0, 0, 0.75),
    0 1px 0 rgba(255, 255, 255, 0.06) inset;

  transition:
    transform 0.14s ease,
    box-shadow 0.14s ease,
    background 0.12s ease;

  -webkit-tap-highlight-color: transparent;
}





body:not(.dark) #capsBtn.caps-green::after {
  opacity: 1;
  transform: scale(1.06);
  box-shadow:
    0 0 0 2px rgba(80,220,140,0.95),
    0 0 20px rgba(80,220,140,0.55),
    0 0 48px rgba(80,220,140,0.32);
}



  </style>
</head>
<body>
  <div class="app">
    <div class="editor">
<div id="textWrapper">
  <textarea id="mainText"
            placeholder="Write here..."
            spellcheck="false"
            autocapitalize="off"
            autocomplete="off"
            autocorrect="off"></textarea>

  <div class="textBtns">
<div id="saveBtn" aria-label="Save" title="Save">
  <img src="icons/save.svg" alt="Save" class="btnIcon">
</div>

<div id="snowToggleBtn" aria-label="Snow toggle" title="Snow on/off">
  <img src="icons/snow.svg" alt="Snow" class="btnIcon">
</div>

  </div>
</div>


<div id="saveModal" aria-hidden="true">
  <div id="saveWrapper" role="dialog" aria-modal="true" aria-label="Saves">
    <h3 style="margin:0 0 6px 0;">Saves</h3>
    <div id="saveList"></div>

    <div id="newSave">
      <input id="saveName" placeholder="Title (max. 60 characters)" maxlength="60" />
      <button id="createSave">Create</button>
    </div>

    <button id="closeSave">Close</button>
  </div>
</div>


      <div style="padding-top:8px; display:flex; justify-content:space-between; align-items:center;">
        <div class="small"></div>
        <div class="small"></div>
      </div>
    </div>

    <div class="keyboard" id="keyboard" aria-live="polite">
      <div class="controls">

        <div class="legend">
          <div style="display:flex;align-items:center;gap:10px">
            <label style="display:flex;align-items:center;gap:6px">
              <input type="checkbox" id="allowPhysical"> lock system keyboard
            </label>

           
            <button class="btn icon-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
              <img class="icon-img" src="icons//settings.svg" alt="settings" decoding="async" draggable="false"
                   onload="this.style.display='inline-block';" onerror="this.style.display='none'">
              <svg class="icon-fallback" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06c.46-.46.6-1.15.33-1.82a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09c.7 0 1.31-.39 1.51-1a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06c.46.46 1.15.6 1.82.33h.09c.61-.2 1-.81 1-1.51V3a2 2 0 014 0v.09c0 .7.39 1.31 1 1.51h.09c.67.27 1.36.13 1.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06c-.46.46-.6 1.15-.33 1.82v.09c.2.61.81 1 1.51 1H21a2 2 0 010 4h-.09c-.7 0-1.31.39-1.51 1z"/>
              </svg>
            </button>

            <button class="btn icon-btn" id="copyBtn" title="Copy all" aria-label="Copy all">
              <img class="icon-img" src="icons//copy.svg" alt="copy" decoding="async" draggable="false"
                   onload="this.style.display='inline-block'; this.parentNode.querySelector('.icon-fallback-copy').style.display='none';"
                   onerror="this.style.display='none'; this.parentNode.querySelector('.icon-fallback-copy').style.display='inline-block'">
              <svg class="icon-fallback icon-fallback-copy" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.8"/>
                <rect x="4" y="4" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.2"/>
              </svg>
            </button>

            <button class="btn icon-btn" id="backspaceBtn" title="Backspace / delete" aria-label="Backspace">
              <img class="icon-img" src="icons//backspace.svg" style="width: 1000px; height: 100px;" alt="backspace" decoding="async" draggable="false"
                   onload="this.style.display='inline-block'; this.parentNode.querySelector('.icon-fallback-back').style.display='none';"
                   onerror="this.style.display='none'; this.parentNode.querySelector('.icon-fallback-back').style.display='inline-block'">
              <svg class="icon-fallback icon-fallback-back" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 6H9L4 12l5 6h11V6z" stroke="currentColor" stroke-width="1.6" fill="none"/>
                <path d="M15 9l-4 4M11 9l4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>

            <button class="btn icon-btn" id="capsBtn" title="Caps (click = one-time, dblclick = lock)" aria-label="Caps">
              <img class="icon-img" id="capsIcon" src="icons//caps.svg" alt="caps" decoding="async" draggable="false"
                   onload="this.style.display='inline-block'; this.parentNode.querySelector('.icon-fallback-caps').style.display='none';"
                   onerror="this.style.display='none'; this.parentNode.querySelector('.icon-fallback-caps').style.display='inline-block'">
              <svg class="icon-fallback icon-fallback-caps" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5l7 7h-4v6h-6v-6H5l7-7z" stroke="currentColor" stroke-width="1.6" fill="none"/>
              </svg>
            </button>

          </div>


<div id="settingsPopup" class="hidden" role="dialog" aria-hidden="true" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã">
  <h4>–Ø–∑—ã–∫ —Ä–∞—Å–∫–ª–∞–¥–∫–∏</h4>
  <select id="langSelect" aria-label="–í—ã–±–æ—Ä —è–∑—ã–∫–∞">
    <option value="default">–ö–∏—Ä–∏–ª–ª–∏—Ü–∞</option>
    <option value="en">English diacritics</option>
    <option value="sa">Sanscrit / Devanagari</option>
  </select>

<div class="note" style="margin-top:6px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage.</div>
</div>


<div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">

  <div class="theme-toggle" id="themeToggle">
    <div class="thumb" id="themeThumb">‚òÄÔ∏è</div>
  </div>

  <button class="btn jumpBtn smallBtn" data-row="1" title=""></button>
  <button class="btn jumpBtn smallBtn" data-row="14" title="Scroll to row 7"></button>
  <button class="btn jumpBtn smallBtn" data-row="27" title="Scroll to row 9"></button>
  <button class="btn icon-btn" id="spaceBtn" title="Space" aria-label="Space">
    <img class="icon-img" src="icons//space.svg" alt="space" decoding="async" draggable="false"
         onload="this.style.display='inline-block'; this.parentNode.querySelector('.icon-fallback-space').style.display='none';"
         onerror="this.style.display='none'; this.parentNode.querySelector('.icon-fallback-space').style.display='inline-block'">
    <svg class="icon-fallback icon-fallback-space" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="10" width="18" height="4" rx="2" stroke="currentColor" stroke-width="1.6" fill="none"/>
    </svg>
  </button>

</div>

        </div>

        <div class="row-controls">
          <div class="status" id="capsStatus"></div>
          <div class="status small" id="colsStatus"></div>
        </div>

      </div>

      <div class="rows" id="rowsContainer"></div>
    </div>
  </div>

  <script>

(function ensureIconFallbacks() {
  const iconButtons = document.querySelectorAll('.icon-btn');
  iconButtons.forEach(btn => {
    const img = btn.querySelector('img.icon-img');
    const fallback = btn.querySelector('svg.icon-fallback');
    if (!img) {
      if (fallback) fallback.style.display = 'inline-block';
      return;
    }

    if (img.complete && img.naturalWidth > 0) {
      img.style.display = 'inline-block';
      if (fallback) fallback.style.display = 'none';
    } else if (img.complete && img.naturalWidth === 0) {
      img.style.display = 'none';
      if (fallback) fallback.style.display = 'inline-block';
    } else {

      img.addEventListener('load', () => {
        img.style.display = 'inline-block';
        if (fallback) fallback.style.display = 'none';
      });
      img.addEventListener('error', () => {
        img.style.display = 'none';
        if (fallback) fallback.style.display = 'inline-block';
      });
    }
  });
})();
</script>

  <script>

(function () {

  function safeLogError(err) {
    console.error('Webkbd error:', err);
  }

  window.addEventListener('error', function (ev) {
    try {
      safeLogError(ev.error || ev.message || ev);
    } catch (e) { console.error(e); }

    try { if (typeof safeRender === 'function') safeRender(); } catch (e) {}
  });

  window.addEventListener('unhandledrejection', function (ev) {
    try {
      safeLogError(ev.reason);
    } catch (e) {}
    try { if (typeof safeRender === 'function') safeRender(); } catch (e) {}
  });


  function addPointerListeners(target, type, handler, options) {
    options = options || {};


    const supportsPointer = typeof window.PointerEvent !== 'undefined';
    const supportsTouch = 'ontouchstart' in window;

    const map = (function() {

      if (supportsPointer) {
        return {
          down: ['pointerdown'],
          move: ['pointermove'],
          up:   ['pointerup','pointercancel'],
          click:['pointerdown'] 
        };
      } else if (supportsTouch) {
        return {
          down: ['touchstart'],
          move: ['touchmove'],
          up:   ['touchend','touchcancel'],
          click:['touchstart'] 
        };
      } else {
        return {
          down: ['mousedown'],
          move: ['mousemove'],
          up:   ['mouseup'],
          click:['mousedown'] 
        };
      }
    })();

    const evNames = map[type] || [type];

    function wrapper(ev) {
      try {
        if (ev && ev.type && ev.type.indexOf('touch') === 0 && ev.changedTouches && ev.changedTouches.length) {
          const t = ev.changedTouches[0];
          const synth = {
            originalEvent: ev,
            type: ev.type,
            clientX: t.clientX,
            clientY: t.clientY,
            pointerType: 'touch',
            preventDefault: function(){ try { ev.preventDefault(); } catch(e){} }
          };
          handler.call(this, synth, ev);
        } else {
          handler.call(this, ev, ev);
        }
      } catch (err) {
        try { handler.call(this, ev, ev); } catch(e){}
      }
    }

    evNames.forEach(name => {
      try {
        target.addEventListener(name, wrapper, options);
      } catch (e) {
        try { target.addEventListener(name, wrapper, !!options.capture); } catch (e2) {}
      }
    });
  }

  const KEYS_DEF = [
    ['–∞','ƒÅ','–∏','”£','—É','”Ø'],
    ['—Ä—å','—Ä—åÃÑ ','—ô','—ôÃÑ '],
    ['‘ë','–æ','”ôƒ±','…î“Ø'],
    ['‚¶Ç','·µí'],
    ['–∫','–∫·∑â ','–≥','–≥·∑â ','”à'],
    ['—á','—á·∑â ','—ü','—ü·∑â ','—ö'],
    ['‘è','‘è·∑â ','‘É','‘É·∑â ','‘ã'],
    ['—Ç','—Ç·∑â ','–¥','–¥·∑â ','–Ω'],
    ['–ø','–ø·∑â ','–±','–±·∑â ','–º'],
    ['–π','—Ä','–ª','–≤'],
    ['—â','—à','—Å','—Ö'],
    ['‚Ä¢','‚Äø','‚ÅÄ','…ê'],
    ['‘ëÃÜ ','–æÃÜ '],

    ['–∞','–±','–≤','–≥','–µ','—ë'],
    ['–∂','–∑','—ñ','–∏','—µ','–∫'],
    ['–ª','–º','–Ω','–æ','–ø','—Ä'],
    ['—Å','—Ç','—É','—Ñ','—≥','—Ö'],
    ['—Ü','—á','—à','—â','—ä','—ã'],
    ['—å','—ç','—é','—è','—£'],
    ['!',',','.','‚Ä¶',':',';'],

    ['‚Äû','"','¬´','¬ª','‚Äπ','‚Ä∫'],
    ['-','‚Äî','_','(',')'],
    ['1','2','3','4','5','6'],
    ['7','8','9','0'],


  ['‚ûÄ','‚ûÅ','‚ûÇ','‚ûÉ','‚ûÑ','‚ûÖ'],
  ['‚ûÜ', '‚ùï', '`','¬∞','‚àö','*'],
  ['^','+','=','‚â†','‚â•','¬±'],
  ['~','‚âà','|','/'],
  ['[',']','{','}','<','>'],
  ['‚Üê','‚Üí','‚Üì','‚Üë','‚Üô','‚Üó']


  ];

  const CAPS_MAP = new Map([
    ['–∞','–ê'], ['ƒÅ','ƒÄ'], ['–∏','–ò'], ['”£','”¢'], ['—É','–£'], ['”Ø','”Æ'],
    ['—Ä—å','–†–¨'], ['—Ä—åÃÑ ','–†–¨ÃÑ '], ['—ô','–â'], ['—ôÃÑ','–âÃÑ'],
    ['‘ë','‘ê'], ['–æ','–û'], ['‚¶Ç','‚¶Ç'], ['”ô','”ò'], ['…î','∆Ü'], ['·µí','·µí'],
    ['–∫','–ö'], ['–∫·∑â','–ö·∑â'], ['–≥','–ì'], ['–≥·∑â','–ì·∑â'], ['”à','”á'],
    ['—á','–ß'], ['—á·∑â','–ß·∑â'], ['—ü','–è'], ['—ü·∑â','–è·∑â'], ['—ö','–ä'],
    ['‘è','‘é'], ['‘è·∑â','‘é·∑â'], ['‘É','‘Ç'], ['‘É·∑â','‘Ç·∑â'], ['‘ã','‘ä'],
    ['—Ç','–¢'], ['—Ç·∑â','–¢·∑â'], ['–¥','–î'], ['–¥·∑â','–î·∑â'], ['–Ω','–ù'],
    ['–ø','–ü'], ['–ø·∑â','–ü·∑â'], ['–±','–ë'], ['–±·∑â','–ë·∑â'], ['–º','–ú'],
    ['–π','–ô'], ['—Ä','–†'], ['–ª','–õ'], ['–≤','–í'],
    ['—â','–©'], ['—à','–®'], ['—Å','–°'], ['—Ö','–•'], ['‘â','‘à'],
    ['–∞','–ê'], ['–±','–ë'], ['–≤','–í'], ['–≥','–ì'], ['–¥','–î'], ['–µ','–ï'], ['—ë','–Å'],
    ['–∂','–ñ'], ['–∑','–ó'], ['—ñ','–Ü'], ['–∏','–ò'], ['—µ','—¥'], ['–∫','–ö'], ['–ª','–õ'],
    ['–º','–ú'], ['–Ω','–ù'], ['–æ','–û'], ['–ø','–ü'], ['—Ä','–†'], ['—Å','–°'], ['—Ç','–¢'],
    ['—É','–£'], ['—Ñ','–§'], ['—≥','—≤'], ['—Ö','–•'], ['—Ü','–¶'], ['—á','–ß'], ['—à','–®'],
    ['—â','–©'], ['—ä','–™'], ['—ã','–´'], ['—å','–¨'], ['—ç','–≠'], ['—é','–Æ'], ['—è','–Ø'],
    ['—£','—¢'],
    ['a','A'], ['b','B'], ['c','C'], ['d','D'], ['e','E'], ['f','F'], ['g','G'], ['h','H'], ['i','I'], ['j','J'],
    ['k','K'], ['l','L'], ['m','M'], ['n','N'], ['o','O'], ['p','P'], ['q','Q'], ['r','R'], ['s','S'], ['t','T'],
    ['u','U'], ['v','V'], ['w','W'], ['x','X'], ['y','Y'], ['z','Z']
  ]);

  function applyCaps(text) {
    if (!text) return text;
    if (!capsOn) return text;
    let res = String(text).normalize('NFC');
    const entries = Array.from(CAPS_MAP.entries()).sort((a, b) => b[0].length - a[0].length);
    for (const [k, v] of entries) {
      if (!k) continue;
      if (res.indexOf(k) === -1) continue;
      res = res.split(k).join(v);
    }
    return res;
  }

  const STORAGE_ALLOW = 'webkbd_allow_v5';
  const STORAGE_COLS  = 'webkbd_cols_v3';
  const STORAGE_CAPS  = 'webkbd_caps_v2';
  const STORAGE_THEME = 'webkbd_theme_v1';
  const STORAGE_FONT  = 'webkbd_font_v1';
  const STORAGE_LANG  = 'webkbd_lang_v1';

  const keyboardEl     = document.getElementById('keyboard') || document.querySelector('.keyboard') || document.body;
  const allowPhysical  = document.getElementById('allowPhysical');
  const mainText       = document.getElementById('mainText');
  const copyBtn        = document.getElementById('copyBtn');
  const backspaceBtn   = document.getElementById('backspaceBtn');
  const spaceBtn       = document.getElementById('spaceBtn');
  const capsBtn        = document.getElementById('capsBtn');
  const themeToggle    = document.getElementById('themeToggle');
  const themeThumb     = document.getElementById('themeThumb');

  let rowsContainer  = document.getElementById('rowsContainer');
  if (!rowsContainer) {
    try {
      rowsContainer = document.createElement('div');
      rowsContainer.id = 'rowsContainer';
      rowsContainer.className = 'rows';

      const controlsEl = keyboardEl.querySelector ? keyboardEl.querySelector('.controls') : null;
      if (controlsEl && controlsEl.parentNode) {
        controlsEl.parentNode.insertBefore(rowsContainer, controlsEl.nextSibling);
      } else {
        keyboardEl.appendChild(rowsContainer);
      }
    } catch (e) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å rowsContainer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', e);
    }
  }

  let maxCols = 6;

  let capsState = 0;
  let capsOn  = false;
  let darkOn  = false;

  let currentLayout = null;


  function applyTheme() {
    try {
      document.body.classList.toggle('dark', !!darkOn);
      if (themeToggle) themeToggle.classList.toggle('night', !!darkOn);
      if (themeThumb) themeThumb.textContent = darkOn ? "üåô" : "‚òÄÔ∏è";
    } catch (e) {
      console.error('applyTheme error', e);
    }
  }

  function saveAll() {
    try {
      if (allowPhysical) localStorage.setItem(STORAGE_ALLOW, JSON.stringify(!!allowPhysical.checked));
      localStorage.setItem(STORAGE_CAPS, JSON.stringify(Number(capsState)));
      localStorage.setItem(STORAGE_THEME, JSON.stringify(!!darkOn));
    } catch (e) {}
  }

  function loadAll() {
    try {
      const a = JSON.parse(localStorage.getItem(STORAGE_ALLOW));
      if (typeof a === 'boolean' && allowPhysical) allowPhysical.checked = a;
    } catch (e) {}
    try {
      const cap = JSON.parse(localStorage.getItem(STORAGE_CAPS));
      if (typeof cap === 'number') {
        capsState = cap;
      } else if (typeof cap === 'string' && cap.length > 0 && !isNaN(Number(cap))) {
        capsState = Number(cap);
      } else {
        capsState = 0;
      }
    } catch (e) { capsState = 0; }
    capsOn = (capsState === 1 || capsState === 2);
    try {
      const th = JSON.parse(localStorage.getItem(STORAGE_THEME));
      if (typeof th === 'boolean') darkOn = th;
    } catch (e) { darkOn = false; }
    updateCapsUI();
    applyTheme();
  }

  function updateBottomPadding() {
    try {
      const h = keyboardEl.getBoundingClientRect().height || 0;
       document.body.style.paddingBottom = h + 'px';
    } catch (e) {}
  }
  try {
    const ro = new ResizeObserver(updateBottomPadding);
    if (keyboardEl && ro) ro.observe(keyboardEl);
    window.addEventListener('orientationchange', () => setTimeout(updateBottomPadding, 200));
    window.addEventListener('resize', () => setTimeout(updateBottomPadding, 100));
  } catch (e) {}

  function buildRows(defRows, cols) {
    const out = [];
    try {
      defRows.forEach(row => {
        if (!Array.isArray(row)) return;
        if (row.length <= cols) {
          out.push(row.slice());
        } else {
          for (let i = 0; i < row.length; i += cols) {
            out.push(row.slice(i, i + cols));
          }
        }
      });
    } catch (e) {
      console.error('buildRows error', e);
    }
    return out;
  }

  function displayTextForKey(originalVal) {
    return applyCaps(originalVal);
  }

  function setSelectionSafe(ta, start, end){
    try { if (typeof ta.focus === 'function') ta.focus(); } catch(e){}
    try {
      if (typeof ta.setSelectionRange === 'function') {
        ta.setSelectionRange(start, end);
      } else if (ta.createTextRange) {
        const range = ta.createTextRange();
        range.collapse(true);
        range.moveEnd('character', end);
        range.moveStart('character', start);
        range.select();
      }
    } catch (e) {}
  }

  function smoothScrollTo(el, top){
    try { if (el.scrollTo) el.scrollTo({ top: top, behavior: 'smooth' }); else el.scrollTop = top; } catch(e){ el.scrollTop = top; }
  }

  function render() {
  try {
    if (!rowsContainer) {
      console.warn('rowsContainer is missing in render(), attempting to recreate.');
      rowsContainer = document.getElementById('rowsContainer');
      if (!rowsContainer && keyboardEl) {
        rowsContainer = document.createElement('div');
        rowsContainer.id = 'rowsContainer';
        rowsContainer.className = 'rows';
        keyboardEl.appendChild(rowsContainer);
      }
      if (!rowsContainer) return;
    }

    while (rowsContainer.firstChild) rowsContainer.removeChild(rowsContainer.firstChild);


    const rows = buildRows(currentLayout || KEYS_DEF, maxCols);
    rows.forEach((rowArr, rowIndex) => {
      try {
        const rowEl = document.createElement('div');
        rowEl.className = 'row';
        rowEl.style.gridTemplateColumns = 'repeat(' + maxCols + ', 1fr)';

        if (!Array.isArray(rowArr) || rowArr.length === 0) {
          const emptyBtn = document.createElement('div');
          emptyBtn.className = 'key empty';
          rowEl.appendChild(emptyBtn);
        } else {
          rowArr.forEach(val => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'key';

            const rawVal = String(val || '').normalize('NFC');
            const storedVal = rawVal.trim();

            btn.dataset.value = storedVal;
            btn.textContent = displayTextForKey(storedVal);



            const isDeva = /[\u0900-\u097F]/.test(storedVal);
            if (isDeva) {
            btn.style.fontFamily = "'SanskritFont', 'Andika', sans-serif";
          }





(function attachSmartTap(button, value) {
  const MOVE_THRESHOLD = 8;
  let start = null;  
  let moved = false;

  addPointerListeners(button, 'down', (ev) => {
    try {
      start = { x: ev.clientX || 0, y: ev.clientY || 0, t: Date.now() };
      moved = false;
    } catch (e) {}
  }, { passive: true });

  addPointerListeners(button, 'move', (ev) => {
    try {
      if (!start) return;
      const dx = Math.abs((ev.clientX || 0) - start.x);
      const dy = Math.abs((ev.clientY || 0) - start.y);
      if (dx > MOVE_THRESHOLD || dy > MOVE_THRESHOLD) moved = true;
    } catch (e) {}
  }, { passive: true });

  addPointerListeners(button, 'up', (ev) => {
    try {
      if (!start) return;
      const dt = Date.now() - start.t;
      if (!moved && dt < 700) {
        insertAtCursor(value);
      }
    } catch (e) {}
    start = null;
    moved = false;
  }, { passive: true });

  button.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      try { insertAtCursor(value); } catch (err) {}
    }
  });

})(btn, storedVal);


            rowEl.appendChild(btn);
          });
        }
        rowsContainer.appendChild(rowEl);
      } catch (eRow) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞ —Å—Ç—Ä–æ–∫–∏', rowIndex, eRow);
      }
    });

    updateBottomPadding();
    try { updateJumpButtons(); } catch (e) {}
  } catch (e) {
    console.error('render fatal error', e);
  }
}



  window.safeRender = function () {
    try { render(); } catch (e) { console.error('safeRender error', e); }
  };

  (function tryRenderRetry() {
    let attempts = 0;
    const maxAttempts = 10;
    const id = setInterval(() => {
      try {
        attempts++;
        if (rowsContainer && rowsContainer.children.length > 0) {
          clearInterval(id);
          return;
        }
        render();
        if (rowsContainer && rowsContainer.children.length > 0) {
          clearInterval(id);
          return;
        }
        if (attempts >= maxAttempts) {
          clearInterval(id);
          setTimeout(() => { try { render(); } catch (e) {} }, 1200);
        }
      } catch (e) {
        if (attempts >= maxAttempts) clearInterval(id);
      }
    }, 200);
  })();

  (function() {
  const btns = document.querySelectorAll('.key');
  const re = /[\u0900-\u097F]/; 

  btns.forEach(b => {
    const t = (b.textContent || '').trim();
    if (re.test(t)) {
      b.classList.add('deva');
    } else {
      b.classList.remove('deva');
    }
  });
})();

  function insertAtCursor(textRaw) {
    try {
      const text = applyCaps(textRaw);
      const ta = mainText;
      const prohibit = !!(allowPhysical && allowPhysical.checked);
      if (!ta) return;
      if (prohibit) ta.readOnly = false;
      const start = (typeof ta.selectionStart === 'number') ? ta.selectionStart : ta.value.length;
      const end = (typeof ta.selectionEnd === 'number') ? ta.selectionEnd : start;
      ta.value = ta.value.substring(0, start) + text + ta.value.substring(end);
      const newPos = start + text.length;

      setSelectionSafe(ta, newPos, newPos);
      if (prohibit) ta.readOnly = true;

      if (capsState === 1) {
        capsState = 0;
        capsOn = false;
        updateCapsUI();
        saveAll();
      }

      ta.dispatchEvent(new Event('input', { bubbles: true }));
      ta.dispatchEvent(new Event('change', { bubbles: true }));
    } catch (e) { console.error('insertAtCursor error', e); }
  }

  function updateCapsUI() {
    try {
      if (!capsBtn) return;
      capsBtn.classList.remove('caps-dim', 'caps-green');
      if (capsState === 1) capsBtn.classList.add('caps-dim');
      if (capsState === 2) capsBtn.classList.add('caps-green');
      capsOn = (capsState !== 0);

      const keyButtons = (rowsContainer && rowsContainer.querySelectorAll) ? rowsContainer.querySelectorAll('.key') : document.querySelectorAll('.key');
      Array.from(keyButtons).forEach(btn => {
        try {
          const val = btn.dataset ? btn.dataset.value : null;
          btn.textContent = displayTextForKey(val);
        } catch (e) {}
      });
    } catch (e) { console.error('updateCapsUI error', e); }
  }

function updateJumpButtons() {
  try {
    if (!rowsContainer) return;
    const jumpBtns = Array.from(document.querySelectorAll('.jumpBtn'));
    if (!jumpBtns.length) return;

    jumpBtns.forEach(btn => {
      try {
        const rowNumRaw = btn.dataset.row;
        if (!rowNumRaw) return;

        const lang = currentLayoutKey || '';
        if (lang === 'sanskrit') {
          if (btn.dataset.row === '3') btn.dataset.targetRow = '3';
          else btn.dataset.targetRow = btn.dataset.row;
        } else if (lang === 'russian') {
          if (btn.dataset.row === '3') btn.dataset.targetRow = '2';
          else btn.dataset.targetRow = btn.dataset.row;
        } else {
          btn.dataset.targetRow = btn.dataset.row;
        }

        const n = parseInt(btn.dataset.targetRow || btn.dataset.row, 10);
        if (isNaN(n)) return;
        const idx = Math.max(0, n - 1); 
        const rowEl = rowsContainer.children[idx];
        if (!rowEl) return;

        const firstKey = rowEl.querySelector('.key:not(.empty)');
        let label = '';
        if (firstKey) {
          const val = firstKey.dataset ? firstKey.dataset.value : (firstKey.textContent || '').trim();
          label = displayTextForKey(val || '');
        }
        if (!label) return;

        btn.textContent = label;
        btn.setAttribute('title', `–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Å—Ç—Ä–æ–∫–µ ${n}: ${label}`);
        btn.setAttribute('aria-label', `Scroll to row ${n}: ${label}`);

        const isDeva = /[\u0900-\u097F]/.test(label);
        if (isDeva) {
          btn.style.fontFamily = "'SanskritFont', 'Andika', sans-serif";
        } else {
          btn.style.fontFamily = '';
        }
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–∏ jump:', e);
      }
    });
  } catch (e) {
    console.error('updateJumpButtons error', e);
  }
}

  function applyKeyboardProhibitMode() {
    try {
      const prohibit = !!(allowPhysical && allowPhysical.checked);
      if (!mainText) return;
      if (prohibit) {
        mainText.setAttribute('inputmode', 'none');
        mainText.readOnly = true;
        const blurOnFocus = (e) => { e.preventDefault(); mainText.blur(); };
        mainText.__blurOnFocus = blurOnFocus;
        try {
          mainText.addEventListener('focus', blurOnFocus, { passive: false });
        } catch(e) {
          try { mainText.addEventListener('focus', blurOnFocus, false); } catch(e){}
        }
        mainText.blur();
      } else {
        mainText.removeAttribute('inputmode');
        mainText.readOnly = false;
        if (mainText.__blurOnFocus) {
          try { mainText.removeEventListener('focus', mainText.__blurOnFocus); } catch(e){}
          delete mainText.__blurOnFocus;
        }
      }
      saveAll();
    } catch (e) { console.error('applyKeyboardProhibitMode error', e); }
  }

  try {
    if (allowPhysical) {
      allowPhysical.addEventListener('change', function () {
        try { applyKeyboardProhibitMode(); } catch (e) {}
      });
    }
  } catch (e) {}

  try {
    if (copyBtn) copyBtn.addEventListener('click', async function () {
      try {
        if (navigator.clipboard && mainText) {
          await navigator.clipboard.writeText(mainText.value);
          const prev = copyBtn.innerHTML;
          copyBtn.textContent = '‚úì';
          setTimeout(() => { copyBtn.innerHTML = prev; }, 900);
        } else if (mainText) {
          mainText.select();
          document.execCommand('copy');
        }
      } catch (e) {
        console.error('copy failed', e);
      }
    }, { passive: true });
  } catch (e) {}

  try {
    if (backspaceBtn) backspaceBtn.addEventListener('click', function () {
      try {
        const ta = mainText;
        if (!ta) return;
        const prohibit = !!(allowPhysical && allowPhysical.checked);
        const start = (typeof ta.selectionStart === 'number') ? ta.selectionStart : ta.value.length;
        const end = (typeof ta.selectionEnd === 'number') ? ta.selectionEnd : start;
        if (prohibit) ta.readOnly = false;
        if (start === end) {
          if (start > 0) {
            const newPos = start - 1;
            ta.value = ta.value.slice(0, newPos) + ta.value.slice(end);
            try { setSelectionSafe(ta, newPos, newPos); } catch (e) {}
          }
        } else {
          ta.value = ta.value.slice(0, start) + ta.value.slice(end);
          try { setSelectionSafe(ta, start, start); } catch (e) {}
        }
        ta.dispatchEvent(new Event('input', { bubbles: true }));
        ta.dispatchEvent(new Event('change', { bubbles: true }));
        if (prohibit) ta.readOnly = true;
      } catch (e) { console.error('backspace handler error', e); }
    }, { passive: true });
  } catch (e) {}

  try {
    if (spaceBtn) spaceBtn.addEventListener('click', function () {
      try { insertAtCursor(' '); } catch (e) {}
    }, { passive: true });
  } catch (e) {}

  try {
    (function setupCapsButton() {
      if (!capsBtn) return;
      const DOUBLE_TAP_MS = 350;
      const LONGPRESS_MS  = 500;
      let lastUpTime = 0;
      let singleTapTimer = null;
      let longpressTimer = null;
      function clearSingle() { if (singleTapTimer) { clearTimeout(singleTapTimer); singleTapTimer = null; } }
      function clearLong() { if (longpressTimer) { clearTimeout(longpressTimer); longpressTimer = null; } }
      function doSingle() {
        if (capsState === 2) {
          capsState = 0;
        } else if (capsState === 0) {
          capsState = 1;
        } else if (capsState === 1) {
          capsState = 0;
        }
        updateCapsUI();
        saveAll();
      }
      function doLock() {
        capsState = 2;
        updateCapsUI();
        saveAll();
      }
      addPointerListeners(capsBtn, 'down', (ev) => {
        clearLong();
        longpressTimer = setTimeout(() => {
          doLock();
          clearSingle();
        }, LONGPRESS_MS);
      }, { passive: true });
      addPointerListeners(capsBtn, 'up', (ev) => {
        clearLong();
        const now = Date.now();
        if (now - lastUpTime <= DOUBLE_TAP_MS) {
          clearSingle();
          doLock();
          lastUpTime = 0;
          return;
        }
        lastUpTime = now;
        clearSingle();
        singleTapTimer = setTimeout(() => {
          doSingle();
          singleTapTimer = null;
          lastUpTime = 0;
        }, Math.min(200, DOUBLE_TAP_MS));
      }, { passive: true });
      try {
        capsBtn.addEventListener('dblclick', function (e) {
          e.preventDefault && e.preventDefault();
          clearSingle();
          clearLong();
          doLock();
        }, { passive: true });
      } catch (e) {}
    })();

  } catch (e) {}

  try {
    function jumpToRow(n) {
      try {
        const idx = Math.max(0, n - 1);
        if (!rowsContainer) return;
        const rowEl = rowsContainer.children[idx];
        if (!rowEl) return;
        const top = rowEl.offsetTop - rowsContainer.offsetTop;
        smoothScrollTo(rowsContainer, top);
      } catch (e) {}
    }
    document.querySelectorAll('.jumpBtn').forEach(btn => {
      try {
        btn.addEventListener('click', () => {
          try {
            const n = parseInt(btn.dataset.row, 10);
            jumpToRow(n);
          } catch (e) {}
        }, { passive: true });
      } catch (e) {}
    });
  } catch (e) {}

  try {
    if (rowsContainer) rowsContainer.addEventListener('touchmove', function(e){ }, { passive: true });
  } catch (e) {}

  try {
    loadAll();
    applyKeyboardProhibitMode();
    render();
  } catch (e) {
    console.error('init error', e);
    try { render(); } catch (e2) { console.error('second render attempt failed', e2); }
  }

(function initThemeToggleButton() {
  try {
    if (!themeToggle) return;

    themeToggle.addEventListener("click", () => {
      darkOn = !darkOn;
      applyTheme();
      saveAll();
    });
  } catch (err) {
    console.error("theme toggle error", err);
  }
})();

(function initSettings() {
  try {
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPopup = document.getElementById('settingsPopup');
    const langSelect = document.getElementById('langSelect');

    const langBtn = document.getElementById('langBtn');
    const langIconImg = document.getElementById('langIconImg');

    settingsBtn && settingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsPopup.classList.toggle('hidden');
      settingsPopup.setAttribute('aria-hidden', settingsPopup.classList.contains('hidden') ? 'true' : 'false');
    });

    document.addEventListener('click', (e) => {
      if (!settingsPopup || !settingsBtn) return;
      if (!settingsPopup.contains(e.target) && !settingsBtn.contains(e.target)) {
        settingsPopup.classList.add('hidden');
        settingsPopup.setAttribute('aria-hidden', 'true');
      }
     

    });


    window.currentLayoutKey = window.currentLayoutKey || 'default';

    const jumpMapping = {
      'default': {
        overrides: {
          '1': { targetRow: 1, label: 'ƒÄƒÅ' },
          '14': { targetRow: 14, label: '–Ø—è' },
          '27': { targetRow: 25, label: '+!' }
        },
        defaultDelta: 0
      },
      'en': {
        overrides: {
          '1': { targetRow: 1, label: 'aƒÅ' },
          '14': { targetRow: 10, label: 'ai' },
          '27': { targetRow: 11, label: '+!' }
        },
        defaultDelta: 0
      },
      'sa': {
        overrides: {
          '3': { targetRow: 3, label: '' },
          '14': { targetRow: 12, label: '‡•¢' },
          '27': { targetRow: 14, label: '‡•ß' }
        },
        defaultDelta: 0
      },
    };

    function updateLangIcon(key) {
      try {
        window.currentLayoutKey = key || 'default';
        if (!langIconImg) return;
        const mapping = {
          'default': './lang_default.svg',
          'en': './lang_en.svg',
          'sa': './lang_sa.svg',
          'russian': './lang_ru.svg'
        };
        if (mapping[key]) langIconImg.src = mapping[key];
        else langIconImg.src = mapping['default'];
      } catch (e) { console.warn('updateLangIcon error', e); }
    }

    function updateJumpButtonsForLang() {
      try {
        if (!rowsContainer) return;
        const jumpBtns = Array.from(document.querySelectorAll('.jumpBtn'));
        if (!jumpBtns.length) return;

        const lang = window.currentLayoutKey || 'default';
        const cfg = jumpMapping[lang] || jumpMapping['default'];

        jumpBtns.forEach(btn => {
          try {
            const baseRow = btn.dataset.row; 
            if (!baseRow) return;

            const ov = (cfg && cfg.overrides && cfg.overrides[baseRow]) ? cfg.overrides[baseRow] : null;
            let target = ov ? ov.targetRow : (Number(baseRow) + (cfg.defaultDelta || 0));
            if (!isFinite(target) || target <= 0) target = Number(baseRow);

            btn.dataset.targetRow = String(target);

            let label = ov && ov.label ? ov.label : '';

            if (!label) {
              const idx = Math.max(0, Number(target) - 1);
              const rowEl = rowsContainer.children[idx];
              if (rowEl) {
                const firstKey = rowEl.querySelector('.key:not(.empty)');
                if (firstKey) {
                  const v = firstKey.dataset ? firstKey.dataset.value : (firstKey.textContent || '').trim();
                  label = displayTextForKey(v || '');
                }
              }
            }

            if (!label) label = btn.textContent || btn.getAttribute('title') || `Row ${target}`;
            btn.textContent = label;
            btn.setAttribute('title', `–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Å—Ç—Ä–æ–∫–µ ${target}: ${label}`);
            btn.setAttribute('aria-label', `Scroll to row ${target}: ${label}`);

            const isDeva = /[\u0900-\u097F]/.test(label);
            if (isDeva) {
              btn.style.fontFamily = "'SanskritFont', 'Andika', sans-serif";
            } else {
              btn.style.fontFamily = '';
            }
          } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–∏ jump (lang):', e);
          }
        });
      } catch (e) {
        console.error('updateJumpButtonsForLang error', e);
      }
    }

    function setLayoutByKey(key) {
      if (key === 'default') {
        currentLayout = null;
        window.currentLayoutKey = 'default';
      } else if (key === 'en') {
        currentLayout = [
          ['a','ƒÅ','i','ƒ´','u','≈´'],
          ['·πõ','·πù','·∏∑','·∏π'],
          ['e','ai','o','au','·πÅ','·∏•'],
          ['k','kh','g','gh','·πÖ'],
          ['c','ch','j','jh','√±'],
          ['·π≠','·π≠h','·∏ç','·∏çh','·πá'],
          ['t','th','d','dh','n'],
          ['p','ph','b','bh','m'],
          ['y','r','l','v'],
          ['≈õ','·π£','s','h','lÃ±'],
          ['‚Äô','-','|'],
          ['. ',',','‚Äú','‚Äù','‚Äò','‚Äô','_','‚Äî',':',';','!','?','/','\\','+','=','(',')','{','}','[',']']
        ];
        window.currentLayoutKey = 'en';
      } else if (key === 'sa') {
        currentLayout = [
          ['‡§Ö','‡§Ü','‡§á','‡§à','‡§â','‡§ä'],
          ['‡§ã','‡•†','‡§å','‡§å‡•®'],
          ['‡§è','‡§ê','‡§ì','‡§î','‡§Ç','‡§É'],
          ['‡§ï','‡§ñ','‡§ó','‡§ò','‡§ô'],
          ['‡§ö','‡§õ','‡§ú','‡§ù','‡§û'],
          ['‡§ü','‡§†','‡§°','‡§¢','‡§£'],
          ['‡§§','‡§•','‡§¶','‡§ß','‡§®'],
          ['‡§™','‡§´','‡§¨','‡§≠','‡§Æ'],
          ['‡§Ø','‡§∞','‡§≤','‡§µ'],
          ['‡§∂','‡§∑','‡§∏'],
          ['‡§π','‡§≥','‡§ï‡•ç‡§∑'],
          ['‡•ç','‡§æ','‡§ø','‡•Ä','‡•Å','‡•Ç'],
          ['‡•É','‡•Ñ','‡•¢','‡•¢‡•®','‡•á','‡•à'],
          ['‡•ã','‡•å','‡•§','‡••','‡§Ω','‡§Å'],
          ['‡•¶','‡•ß','‡•®','‡•©','‡•™','‡•´'],
          ['‡•¨','‡•≠','‡•Æ','‡•Ø'],
        ];
        window.currentLayoutKey = 'sa';
      } else if (key === 'russian') {

        currentLayout = KEYS_DEF; 
        window.currentLayoutKey = 'russian';
      } else {
        currentLayout = null;
        window.currentLayoutKey = 'default';
      }

      render();
      localStorage.setItem(STORAGE_LANG, key);
      updateLangIcon(window.currentLayoutKey);
      setTimeout(updateJumpButtonsForLang, 60);
    }

langSelect.addEventListener('change', (e) => {
  setLayoutByKey(e.target.value);

  settingsPopup.classList.add('hidden');
});

langSelect.addEventListener('blur', () => {
  settingsPopup.classList.add('hidden');
});



    (function restoreSettings() {
      try {
        const savedLang = localStorage.getItem(STORAGE_LANG);
        const effective = savedLang || langSelect.value || 'default';
        if (savedLang) {
          langSelect.value = savedLang;
        }
        setLayoutByKey(effective);
      } catch (e) { console.warn(e); }
    })();


    document.querySelectorAll('.jumpBtn').forEach(btn => {
      try {
        btn.addEventListener('click', () => {
          try {
            const raw = btn.dataset.targetRow || btn.dataset.row;
            const n = parseInt(raw, 10);
            if (!isNaN(n)) jumpToRow(n);
          } catch (e) {}
        }, { passive: true });
      } catch (e) {}
    });

  } catch (err) {
    console.error('initSettings error', err);
  }
})();
})();
</script>

<script>
(function(){
  const langBtn = document.getElementById('langBtn');
  const langSelect = document.getElementById('langSelect');
  const langSheet = document.getElementById('langSheet'); 
  const settingsPopup = document.getElementById('settingsPopup');

  if (!langSelect) return;

  function isMobile() {
    return window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
  }

  function openSelectLikeDesktop(sel) {
    try {
      if (typeof sel.showPicker === 'function' && !isMobile()) {
        sel.showPicker();
        return;
      }
    } catch(e){}

    try {
      const isSmallScreen = window.matchMedia && window.matchMedia('(max-width: 900px)').matches;
      if (!isSmallScreen) {
        sel.focus();
        sel.click();
      }
    } catch (e) {}
  }

  if (langBtn) {
    langBtn.addEventListener('click', function(ev) {
      ev.preventDefault();
      ev.stopPropagation();

      if (isMobile()) {
        if (langSheet) langSheet.classList.remove('hidden');
        if (settingsPopup) settingsPopup.classList.add('hidden');
        return;
      }

      if (settingsPopup && settingsPopup.classList.contains('hidden')) {
        settingsPopup.classList.remove('hidden');
        settingsPopup.setAttribute('aria-hidden', 'false');
        setTimeout(() => openSelectLikeDesktop(langSelect), 80);
      } else {
        openSelectLikeDesktop(langSelect);
      }
    }, { passive: false });
  } else {
    langSelect.addEventListener('click', function(ev) {
      if (!isMobile()) {
        setTimeout(() => openSelectLikeDesktop(langSelect), 0);
      }
    }, { passive: true });
  }

  if (langSheet) {
    const sheetBox = langSheet.querySelector('.lang-sheet-box');

    langSheet.addEventListener('click', (e) => {
      if (!sheetBox.contains(e.target)) {
        langSheet.classList.add('hidden');
        return;
      }

      const item = e.target.closest('.lang-item');
      if (!item) return;
      const lang = item.dataset.lang;
      if (!lang) return;

      try { setLayoutByKey(lang); } catch (err) {}
      document.querySelectorAll('.lang-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');

      langSheet.classList.add('hidden');
      if (settingsPopup) settingsPopup.classList.add('hidden');
    });
  }

})();
</script>


<script>

const REDIRECT_URL = "./index.html";
const LS_KEY = "device_choice_saved";        


function isMobileDevice() {
  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile|Windows Phone/i.test(navigator.userAgent);
}

if (!isMobileDevice() && localStorage.getItem(LS_KEY) === "redirect") {
  window.location.href = REDIRECT_URL;
}

if (!isMobileDevice() && localStorage.getItem(LS_KEY) === "closed") {
}
else if (!isMobileDevice()) {


if (!isMobileDevice()) {

  const overlay = document.createElement("div");
  overlay.id = "pc-block-overlay";
  overlay.style.cssText = `
    position: fixed;
    inset: 0;
    background: white;
    z-index: 999999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: system-ui, sans-serif;
  `;

const logoWrap = document.createElement("div");
logoWrap.style.cssText = `
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin-top: 0px;     
    margin-bottom: 2px; 
`;


const logoImg = document.createElement("img");
logoImg.src = "icons//infoIcon.svg";   
logoImg.style.cssText = `
    width: 110px;
    height: auto;
    display: block;
    margin: 0 auto;            
`;

logoWrap.appendChild(logoImg);
overlay.appendChild(logoWrap);




  const btnClose = document.createElement("button");
  btnClose.textContent = "‚úñ";
  btnClose.style.cssText = `
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 10px 16px;
    font-size: 16px;
    border-radius: 20px;
    border: 1px solid transparent;
    background: white;
    color: #242424;
    cursor: pointer;
  `;
  btnClose.onclick = () => {
  if (checkboxRemember.checked) {
    localStorage.setItem(LS_KEY, "closed");  
  }
  overlay.remove();
};




  const goBtn = document.createElement("button");
  goBtn.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–µ—Ä—Å–∏—é –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤";
  goBtn.style.cssText = `
    padding: 16px 24px;
    font-size: 20px;
    border-radius: 40px;
    background: #242424;
    border: none;
    color: white;
    cursor: pointer;
    margin-top: 20px;
  `;
  goBtn.onclick = () => {
    if (checkboxRemember.checked) {
      localStorage.setItem(LS_KEY, "redirect");
    }
    window.location.href = REDIRECT_URL;
  };


  const checkboxLabel = document.createElement("label");
  checkboxLabel.style.cssText = `
    margin-top: 24px;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #242424;
  `;

  const checkboxRemember = document.createElement("input");
  checkboxRemember.type = "checkbox";

  checkboxLabel.appendChild(checkboxRemember);
  checkboxLabel.appendChild(document.createTextNode("–ó–∞–ø–æ–º–Ω–∏—Ç—å –≤—ã–±–æ—Ä"));


  overlay.appendChild(btnClose);
  overlay.appendChild(goBtn);
  overlay.appendChild(checkboxLabel);

  document.body.appendChild(overlay);
}
}
</script>


<style>
  #snowCanvas {
    position: fixed;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 9999;

    -webkit-mask-image: linear-gradient(#000 0 0);
    mask-image: linear-gradient(#000 0 0);
  }
</style>

<script>
(function() {

    const canvas = document.createElement("canvas");
    canvas.id = "snowCanvas";
    document.body.appendChild(canvas);

    const ctx = canvas.getContext("2d");
    const DPR = window.devicePixelRatio || 1;

    let flakes = [];

function targetFlakes() {
  const base = Math.floor((canvas.width * canvas.height) / 6000);

  const isMobileOrTablet =
    window.matchMedia('(pointer: coarse)').matches ||
    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);

  return isMobileOrTablet ? Math.floor(base / 5) : base;
}



    function resizeCanvas() {
        const w = window.innerWidth;
        const h = window.innerHeight;

        canvas.style.width = w + "px";
        canvas.style.height = h + "px";

        canvas.width = w * DPR;
        canvas.height = h * DPR;

        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

        const need = targetFlakes();
        flakes = [];
        for (let i = 0; i < need; i++) {
            flakes.push(makeFlake(w, h));
        }
    }

    function makeFlake(w, h) {
        return {
            x: Math.random() * w,
            y: Math.random() * h,

            r: 1.5 + Math.random() * 3.5,   
            vy: 0.6 + Math.random() * 1.4,  

            vx: -0.2 + Math.random() * 0.4,

            sway: 0.4 + Math.random() * 1.0,

            phase: Math.random() * Math.PI * 2,

            alpha: 0.6 + Math.random() * 0.4
        };
    }

    function flakeColor(alpha) {
        const dark = document.body.classList.contains("dark");
        return dark
            ? `rgba(255,255,255,${alpha})`
            : `rgba(160,210,255,${alpha})`; 
    }

    function loop() {
        const w = canvas.width / DPR;
        const h = canvas.height / DPR;

        ctx.clearRect(0, 0, w, h);

        for (let flake of flakes) {

            flake.phase += 0.003 + Math.random() * 0.003;

            const sway = Math.sin(flake.phase) * flake.sway * 0.3;

            const drift = (Math.random() - 0.5) * 0.08;

            flake.x += flake.vx + sway + drift;
            flake.y += flake.vy;

            if (flake.y > h + 5 || flake.x < -10 || flake.x > w + 10) {
                Object.assign(flake, makeFlake(w, h), { y: -10 });
            }

            ctx.beginPath();
            ctx.fillStyle = flakeColor(flake.alpha);
            ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
            ctx.fill();
        }

        requestAnimationFrame(loop);
    }

    window.addEventListener("resize", resizeCanvas);

    resizeCanvas();
    loop();

})();
</script>




<div id="langSheet" class="lang-sheet hidden">
  <div class="lang-sheet-box">
    <div class="lang-item" data-lang="ru">
      <span>–ö–∏—Ä–∏–ª–ª–∏—Ü–∞</span>
      <span class="radio"></span>
    </div>
    <div class="lang-item" data-lang="en">
      <span>English diacritics</span>
      <span class="radio"></span>
    </div>
    <div class="lang-item" data-lang="sa">
      <span>Sanscrit / Devanagari</span>
      <span class="radio"></span>
    </div>
  </div>
</div>


<script>
(function () {
  const langSheet = document.getElementById('langSheet');
  if (!langSheet) return;

  const sheetBox = langSheet.querySelector('.lang-sheet-box');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPopup = document.getElementById('settingsPopup');

  function isMobile() {
    return window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
  }

  if (settingsBtn) {
    settingsBtn.addEventListener('click', (e) => {
      if (!isMobile()) return;
      e.preventDefault();
      e.stopPropagation();
      langSheet.classList.remove('hidden');
      const first = langSheet.querySelector('.lang-item');
      if (first) first.focus && first.focus();
    }, { passive: false });
  }

  function addTapHandler(el, fn) {
    let start = null;
    let moved = false;

    const MOVE_THRESHOLD = 12; 
    const LONGPRESS_MS = 700;

    function onDown(ev) {
      moved = false;
      start = { x: (ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX)) || 0,
                y: (ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY)) || 0,
                t: Date.now() };
      try { ev.preventDefault && ev.preventDefault(); } catch(e){}
    }

    function onMove(ev) {
      if (!start) return;
      const x = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX) || 0;
      const y = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || 0;
      if (Math.abs(x - start.x) > MOVE_THRESHOLD || Math.abs(y - start.y) > MOVE_THRESHOLD) moved = true;
    }

    function onUp(ev) {
      if (!start) return;
      const dt = Date.now() - start.t;
      if (!moved && dt < LONGPRESS_MS) {
        ev.preventDefault && ev.preventDefault();
        fn.call(el, ev);
      }
      start = null;
      moved = false;
    }

    if (window.PointerEvent) {
      el.addEventListener('pointerdown', onDown, { passive: true });
      el.addEventListener('pointermove', onMove, { passive: true });
      el.addEventListener('pointerup', onUp, { passive: false });
      el.addEventListener('pointercancel', () => { start = null; moved = false; }, { passive: true });
    } else {
      el.addEventListener('touchstart', onDown, { passive: true });
      el.addEventListener('touchmove', onMove, { passive: true });
      el.addEventListener('touchend', onUp, { passive: false });
      el.addEventListener('click', function (ev) {
        fn.call(el, ev);
      }, { passive: false });
    }
  }

  function initLangSheet() {
    const items = Array.from(langSheet.querySelectorAll('.lang-item'));
    if (!items.length) return;

    items.forEach(item => {
      item.tabIndex = 0;

addTapHandler(item, function (ev) {
  const lang = item.dataset.lang;
  if (!lang) return;

  const langSelect = document.getElementById('langSelect');
  if (!langSelect) return;

  langSelect.value = lang;

  langSelect.dispatchEvent(new Event('change', { bubbles: true }));

  items.forEach(i => i.classList.remove('active'));
  item.classList.add('active');

  langSheet.classList.add('hidden');
  settingsPopup.classList.add('hidden');
});


      item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.click && item.click();
        }
      });
    });

    addTapHandler(langSheet, function (ev) {
      if (!sheetBox.contains(ev.target)) {
        langSheet.classList.add('hidden');
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLangSheet);
  } else {
    initLangSheet();
  }
})();
</script>



<script>
(function () {
  const btn = document.getElementById('snowToggleBtn');
  if (!btn) return;

  const KEY = 'snow_enabled';

  function getCanvas() {
    return document.getElementById('snowCanvas');
  }

  function setSnow(on) {
    const canvas = getCanvas();
    if (!canvas) return;

    canvas.style.display = on ? 'block' : 'none';
    btn.classList.toggle('off', !on);
    localStorage.setItem(KEY, on ? '1' : '0');
  }

  const enabled = localStorage.getItem(KEY) !== '0';
  setSnow(enabled);

  btn.addEventListener('click', () => {
    const canvas = getCanvas();
    if (!canvas) return;

    const isOn = canvas.style.display !== 'none';
    setSnow(!isOn);
  });
})();
</script>



</body>
</html>
